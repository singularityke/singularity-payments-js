---
title: C2B Payments
description: Accept customer-initiated M-Pesa payments to your business Paybill or Till number
---

import { Tab, Tabs } from "fumadocs-ui/components/tabs";
import { Callout } from "fumadocs-ui/components/callout";
import { Cards, Card } from "fumadocs-ui/components/card";

## Overview

C2B (Customer to Business) payments allow customers to initiate payments directly from their M-Pesa to your business Paybill or Till number. Unlike STK Push where the business initiates the payment, C2B transactions are customer-initiated through the M-Pesa menu or USSD.

## How It Works

1. Register your validation and confirmation URLs with M-Pesa
2. Customer sends money to your Paybill/Till number via M-Pesa
3. M-Pesa sends a validation request to your system (optional)
4. Your system validates and responds to accept or reject the payment
5. M-Pesa completes or cancels based on your validation response
6. M-Pesa sends transaction details to your confirmation URL
7. Your application processes the confirmed payment

## Key Differences from STK Push

| Feature                 | STK Push                        | C2B                                     |
| ----------------------- | ------------------------------- | --------------------------------------- |
| **Initiator**           | Business initiates              | Customer initiates                      |
| **Payment Flow**        | Push prompt to customer's phone | Customer uses M-Pesa menu               |
| **Validation**          | Not available                   | Optional validation step                |
| **Use Case**            | Online checkout, invoices       | Walk-in payments, offline transactions  |
| **Customer Experience** | Receives prompt automatically   | Manually enters Paybill/Till and amount |

## Configure Callback Routes

M-Pesa does not allow URLs containing the word "mpesa" in callback endpoints. Add a catch-all route to handle all M-Pesa requests.

<Tabs items={["Next.js", "SvelteKit", "Nuxt", "Elysia", "Express", "Fastify", "Hono"]}>
  <Tab value="Next.js">
```typescript title="app/api/payments/[...mpesa]/route.ts"
import { mpesa } from "@/lib/mpesa";

export const { POST } = mpesa.handlers.catchAll;
```
  </Tab>

  <Tab value="SvelteKit">
```typescript title="src/routes/api/payments/[...path]/+server.ts"
import { mpesa } from "$lib/mpesa";

export const POST = mpesa.handlers.catchAll.POST;
```
  </Tab>

  <Tab value="Nuxt">
```typescript title="server/api/payments/[...path].ts"
import { mpesa } from "../../utils/mpesa";

export default mpesa.handlers.catchAll;
```
  </Tab>

  <Tab value="Elysia">
```typescript title="index.ts"
import { Elysia } from "elysia";
import { mpesa } from "./utils/mpesa";

const app = new Elysia()
.group("/api/mpesa", (app) => app.use(mpesa.app))
.group("/api/payments", (app) => app.use(mpesa.app))
.listen(3000);

````
  </Tab>

  <Tab value="Express">
```typescript title="index.ts"
import express from "express";
import { mpesaRouter } from "./mpesa";

const app = express();

app.use("/api/mpesa", mpesaRouter);
app.use("/api/payments", mpesaRouter);

app.listen(3000);
````

  </Tab>

  <Tab value="Fastify">
```typescript title="index.ts"
import Fastify from "fastify";
import { mpesa } from "./mpesa";

const fastify = Fastify();

fastify.register(
async (instance) => {
mpesa.router(instance);
},
{ prefix: "/api/mpesa" }
);

fastify.register(
async (instance) => {
mpesa.router(instance);
},
{ prefix: "/api/payments" }
);

await fastify.listen({ port: 3000 });

````
  </Tab>

  <Tab value="Hono">
```typescript title="index.ts"
import { Hono } from "hono";
import { mpesa } from "./mpesa";

const app = new Hono();

app.route("/api/mpesa", mpesa.app);
app.route("/api/payments", mpesa.app);

export default app;
````

  </Tab>
</Tabs>

## Initialize Client with Callbacks

Configure your MpesaClient with callback handlers for validation and confirmation.

```typescript
import { createMpesa } from "@singularity-payments/elysia"; // whatever framework you are using

export const mpesa = createMpesa(
  {
    consumerKey: process.env.MPESA_CONSUMER_KEY!,
    consumerSecret: process.env.MPESA_CONSUMER_SECRET!,
    passkey: process.env.MPESA_PASSKEY!,
    shortcode: process.env.MPESA_SHORTCODE!,
    environment: "sandbox",
    callbackUrl: process.env.MPESA_CALLBACK_URL!,
    initiatorName: process.env.MPESA_INITIATOR_NAME!,
    securityCredential: process.env.MPESA_SECURITY_CREDENTIAL!,
    resultUrl: "https://yourdomain.com/api/payments/result",
    timeoutUrl: "https://yourdomain.com/api/payments/timeout",
  },
  {
    callbackOptions: {
      onC2BValidation: async (data) => {
        console.log("Validating C2B payment:", {
          amount: data.amount,
          phone: data.msisdn,
          billRef: data.billRefNumber,
          transactionId: data.transactionId,
        });

        if (data.amount < 10) {
          console.log("Payment rejected: Amount too low");
          return false;
        }

        return true;
      },

      onC2BConfirmation: async (data) => {
        console.log("C2B Payment confirmed:", {
          transactionId: data.transactionId,
          amount: data.amount,
          phone: data.msisdn,
          billRef: data.billRefNumber,
          time: data.transactionTime,
          firstName: data.firstName,
        });
      },
    },
  },
);
```

## Register C2B URLs

Before receiving C2B payments, register your validation and confirmation URLs with M-Pesa. This only needs to be done once per shortcode.

<Callout type="warning">
  Confirmation and validation URLs cannot contain the word "mpesa" and must be
  publicly accessible. Use ngrok for local testing.
</Callout>

<Tabs items={['Server-Side', 'Client-Side']}>
  <Tab value="Server-Side">
```typescript
const response = await mpesa.client.registerC2BUrl({
  shortCode: "600996",
  responseType: "Completed",
  confirmationURL: "https://yourdomain.com/api/payments/c2b-confirmation",
  validationURL: "https://yourdomain.com/api/payments/c2b-validation",
});

console.log(response);

````

**Response:**

```json
{
  "OriginatorCoversationID": "29115-34620561-1",
  "ResponseCode": "0",
  "ResponseDescription": "Success"
}
```

  </Tab>

  <Tab value="Client-Side">
```typescript
const response = await mpesaClient.registerC2BUrl({
  shortCode: "600996",
  responseType: "Completed",
  confirmationURL: "https://yourdomain.com/api/payments/c2b-confirmation",
  validationURL: "https://yourdomain.com/api/payments/c2b-validation",
});

if (response.ResponseCode === "0") {
console.log("URLs registered successfully");
}

````

  </Tab>
</Tabs>

### Registration Parameters

| Parameter         | Type   | Required | Description                                               |
| ----------------- | ------ | -------- | --------------------------------------------------------- |
| `shortCode`       | string | Yes      | Your Paybill or Till number                               |
| `responseType`    | string | Yes      | Default action on timeout: `"Completed"` or `"Cancelled"` |
| `confirmationURL` | string | Yes      | URL to receive successful transaction confirmations       |
| `validationURL`   | string | Yes      | URL to validate transactions before completion            |

**Important Notes:**

- Register URLs only once per shortcode
- URLs cannot contain "mpesa"
- URLs must be publicly accessible
- Both URLs must respond within the timeout period
- `responseType` determines behavior if validation endpoint times out

## Handle Validation Callbacks

Validation callbacks allow you to accept or reject payments before completion. Use this for:

- Verifying payment amounts match expected values
- Checking if account references are valid
- Preventing duplicate payments
- Implementing business rules

```typescript
const mpesa = new MpesaClient(
  {
    consumerKey: process.env.MPESA_CONSUMER_KEY!,
    consumerSecret: process.env.MPESA_CONSUMER_SECRET!,
    passkey: process.env.MPESA_PASSKEY!,
    shortcode: process.env.MPESA_SHORTCODE!,
    environment: "sandbox",
    callbackUrl: process.env.MPESA_CALLBACK_URL!,
  },
  {
    callbackOptions: {
      onC2BValidation: async (data) => {
        console.log("Validating payment:", {
          amount: data.amount,
          phone: data.msisdn,
          billRef: data.billRefNumber,
          transId: data.transactionId,
        });

        if (data.amount < 100) {
          console.log("Payment rejected: Amount too low");
          return false;
        }

        const invoice = await db.invoices.findUnique({
          where: { reference: data.billRefNumber },
        });

        if (!invoice) {
          console.log("Payment rejected: Invalid reference");
          return false;
        }

        return true;
      },
    },
  },
);
```

### Validation Data Structure

```typescript
interface ParsedC2BCallback {
  transactionType: string;
  transactionId: string;
  transactionTime: string;
  amount: number;
  businessShortCode: string;
  billRefNumber: string;
  invoiceNumber?: string;
  msisdn: string;
  firstName?: string;
  middleName?: string;
  lastName?: string;
}
```

## Handle Confirmation Callbacks

Confirmation callbacks receive details of completed transactions. Process successful payments here.

```typescript
const mpesa = new MpesaClient(
  {
    consumerKey: process.env.MPESA_CONSUMER_KEY!,
    consumerSecret: process.env.MPESA_CONSUMER_SECRET!,
    passkey: process.env.MPESA_PASSKEY!,
    shortcode: process.env.MPESA_SHORTCODE!,
    environment: "sandbox",
    callbackUrl: process.env.MPESA_CALLBACK_URL!,
  },
  {
    callbackOptions: {
      onC2BConfirmation: async (data) => {
        console.log("Payment confirmed:", {
          transactionId: data.transactionId,
          amount: data.amount,
          phone: data.msisdn,
          billRef: data.billRefNumber,
          time: data.transactionTime,
          firstName: data.firstName,
        });

        await db.payments.create({
          data: {
            transactionId: data.transactionId,
            amount: data.amount,
            phoneNumber: data.msisdn,
            billReference: data.billRefNumber,
            firstName: data.firstName,
            transactionTime: new Date(data.transactionTime),
            status: "completed",
          },
        });

        if (data.billRefNumber) {
          await db.invoices.update({
            where: { reference: data.billRefNumber },
            data: {
              status: "paid",
              paidAt: new Date(),
            },
          });
        }

        await sendPaymentConfirmation({
          phone: data.msisdn,
          amount: data.amount,
          transactionId: data.transactionId,
        });
      },
    },
  },
);
```

## Simulate C2B Payments (Sandbox Only)

Test C2B payments in the sandbox environment without using the M-Pesa app.

```typescript
const response = await mpesa.client.simulateC2B({
  shortCode: "600996",
  amount: 100,
  msisdn: "254712345678",
  billRefNumber: "INV001",
  commandID: "CustomerPayBillOnline",
});

console.log(response);
```

**Response:**

```json
{
  "ConversationID": "AG_20231222_00004e9f4a5d6c7b8a9d",
  "OriginatorCoversationID": "29115-34620561-1",
  "ResponseDescription": "Accept the service request successfully."
}
```

### Simulation Parameters

| Parameter       | Type   | Required | Description                                             |
| --------------- | ------ | -------- | ------------------------------------------------------- |
| `shortCode`     | string | No       | Your Paybill/Till number (defaults to config)           |
| `amount`        | number | Yes      | Transaction amount in KES                               |
| `msisdn`        | string | Yes      | Customer phone number                                   |
| `billRefNumber` | string | Yes      | Account reference (max 20 characters)                   |
| `commandID`     | string | No       | `"CustomerPayBillOnline"` or `"CustomerBuyGoodsOnline"` |

<Callout type="info">
  After simulating, M-Pesa will send validation and confirmation callbacks to
  your registered URLs.
</Callout>

## Testing Locally with ngrok

```bash
ngrok http 3000
```

Use the ngrok URL when registering C2B URLs:

```typescript
await mpesa.client.registerC2BUrl({
  shortCode: "600996",
  responseType: "Completed",
  confirmationURL: "https://abc123.ngrok.io/api/payments/c2b-confirmation",
  validationURL: "https://abc123.ngrok.io/api/payments/c2b-validation",
});
```

## Best Practices

### Validate Callback IP Addresses

```typescript
callbackOptions: {
  validateIp: true,
}
```

This ensures callbacks originate from Safaricom's servers.

### Prevent Duplicate Processing

```typescript
onC2BConfirmation: async (data) => {
  const existing = await db.payment.findUnique({
    where: { transactionId: data.transactionId },
  });

  if (existing) {
    console.log("Duplicate transaction ignored");
    return;
  }

  await db.payment.create({
    data: {
      transactionId: data.transactionId,
      amount: data.amount,
      phoneNumber: data.msisdn,
      status: "completed",
    },
  });
};
```

### Handle Validation Timeouts

Choose `responseType` based on your requirements:

```typescript
responseType: "Completed";
```

Accepts payments if validation endpoint is unavailable.

```typescript
responseType: "Cancelled";
```

Rejects payments if validation fails or times out.

### Store Complete Transaction Data

```typescript
await db.payment.create({
  data: {
    transactionId: data.transactionId,
    transactionType: data.transactionType,
    amount: data.amount,
    phoneNumber: data.msisdn,
    businessShortCode: data.businessShortCode,
    billReference: data.billRefNumber,
    invoiceNumber: data.invoiceNumber,
    firstName: data.firstName,
    middleName: data.middleName,
    lastName: data.lastName,
    transactionTime: new Date(data.transactionTime),
    rawData: JSON.stringify(data),
  },
});
```

### Implement Idempotency

```typescript
onC2BConfirmation: async (data) => {
  await db.$transaction(async (tx) => {
    const payment = await tx.payment.upsert({
      where: { transactionId: data.transactionId },
      create: {
        transactionId: data.transactionId,
        amount: data.amount,
        phoneNumber: data.msisdn,
        status: "completed",
      },
      update: {},
    });

    if (payment.createdAt.getTime() === payment.updatedAt.getTime()) {
      await tx.invoice.update({
        where: { reference: data.billRefNumber },
        data: { status: "paid" },
      });
    }
  });
};
```

### Set Validation Timeout

```typescript
onC2BValidation: async (data) => {
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error("Timeout")), 5000);
  });

  const validationPromise = async () => {
    const invoice = await db.invoice.findUnique({
      where: { reference: data.billRefNumber },
    });
    return !!invoice;
  };

  try {
    return await Promise.race([validationPromise(), timeoutPromise]);
  } catch (error) {
    return true;
  }
};
```

## Customer Payment Instructions

### For Paybill

```text
1. Go to M-Pesa menu
2. Select "Lipa na M-Pesa"
3. Select "Pay Bill"
4. Enter Business Number: [YOUR_PAYBILL]
5. Enter Account Number: [INVOICE_NUMBER or CUSTOMER_ID]
6. Enter Amount: [AMOUNT]
7. Enter PIN and confirm
```

### For Till Number

```text
1. Go to M-Pesa menu
2. Select "Lipa na M-Pesa"
3. Select "Buy Goods and Services"
4. Enter Till Number: [YOUR_TILL]
5. Enter Amount: [AMOUNT]
6. Enter PIN and confirm
```

## Troubleshooting

### Callbacks Not Received

**Possible Causes:**

- URLs not registered correctly
- Callback URLs not publicly accessible
- Firewall blocking Safaricom IPs
- Wrong shortcode registered

**Solutions:**

```bash
curl https://yourdomain.com/api/payments/c2b-confirmation

ngrok http 3000
```

Verify Safaricom IPs are whitelisted: 196.201.214.200, 196.201.214.206, 196.201.213.114

### Invalid Shortcode Error

**Cause:** Using wrong shortcode for the environment

**Solution:**

```typescript
shortCode: "600000";
```

Use test shortcode in sandbox.

```typescript
shortCode: "123456";
```

Use actual Paybill/Till number in production.

### Validation Always Timing Out

**Causes:**

- Validation endpoint taking too long
- Database queries too slow
- External API calls in validation

**Solution:** Implement timeout handling as shown in Best Practices.

## Complete Example

```typescript
import { createMpesa } from "@singularity-payments/elysia";
import { Elysia } from "elysia";

const mpesa = createMpesa(
  {
    consumerKey: process.env.MPESA_CONSUMER_KEY!,
    consumerSecret: process.env.MPESA_CONSUMER_SECRET!,
    passkey: process.env.MPESA_PASSKEY!,
    shortcode: process.env.MPESA_SHORTCODE!,
    environment: "sandbox",
    callbackUrl: process.env.MPESA_CALLBACK_URL!,
    initiatorName: process.env.MPESA_INITIATOR_NAME!,
    securityCredential: process.env.MPESA_SECURITY_CREDENTIAL!,
    resultUrl: "https://yourdomain.com/api/payments/result",
    timeoutUrl: "https://yourdomain.com/api/payments/timeout",
  },
  {
    callbackOptions: {
      onC2BValidation: async (data) => {
        if (data.amount < 10) {
          return false;
        }

        const invoice = await db.invoice.findUnique({
          where: { reference: data.billRefNumber },
        });

        return !!invoice;
      },

      onC2BConfirmation: async (data) => {
        await db.payment.create({
          data: {
            transactionId: data.transactionId,
            amount: data.amount,
            phoneNumber: data.msisdn,
            billReference: data.billRefNumber,
            status: "completed",
          },
        });
      },
    },
  },
);

const app = new Elysia()
  .group("/api/payments", (app) => app.use(mpesa.app))
  .group("/api/test", (app) =>
    app
      .post("/register-c2b", async () => {
        const response = await mpesa.client.registerC2BUrl({
          shortCode: "600996",
          responseType: "Completed",
          confirmationURL:
            "https://yourdomain.com/api/payments/c2b-confirmation",
          validationURL: "https://yourdomain.com/api/payments/c2b-validation",
        });

        return {
          success: true,
          data: response,
        };
      })
      .post("/simulate-c2b", async ({ body }) => {
        const { amount, msisdn, billRefNumber } = body as any;

        const response = await mpesa.client.simulateC2B({
          shortCode: "600996",
          amount: amount || 100,
          msisdn: msisdn || "254712345678",
          billRefNumber: billRefNumber || `TEST${Date.now()}`,
        });

        return {
          success: true,
          data: response,
        };
      }),
  )
  .listen(3000);
```

## Next Steps

<Cards>
  <Card title="STK Push" href="/api-reference/stk-push">
    Initiate payments from your application
  </Card>

<Card title="Transaction Status" href="/api-reference/transaction-status">
  Query payment status
</Card>

<Card title="Reversal" href="/api-reference/reversal">
  Reverse incorrect payments
</Card>

  <Card title="B2C Payments" href="/api-reference/b2c">
    Send money to customers
  </Card>
</Cards>
